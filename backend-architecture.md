# ğŸ—ï¸ Water Buddy åç«¯æ¶æ„è®¾è®¡æ–¹æ¡ˆ

> **æ ¸å¿ƒæ–¹æ¡ˆï¼šSupabase Serverless BaaS**  
> é›¶éƒ¨ç½²æˆæœ¬ | å®æ—¶åŒæ­¥ | å®Œå…¨å…è´¹

---

## ğŸ¯ æŠ€æœ¯æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Angular PWA (iPhone 15/16)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ IndexedDB    â”‚  â”‚  Service Worker       â”‚   â”‚
â”‚  â”‚ ç¦»çº¿å­˜å‚¨     â”‚  â”‚  - ç¼“å­˜ç­–ç•¥           â”‚   â”‚
â”‚  â”‚ - å–æ°´è®°å½•   â”‚  â”‚  - åå°åŒæ­¥           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ HTTPS + WebSocket (å®æ—¶åŒå‘é€šä¿¡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase (BaaS å¹³å°)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Realtime     â”‚  â”‚  PostgreSQL Database     â”‚ â”‚
â”‚  â”‚ - WebSocket  â”‚  â”‚  - å®¶åº­æ•°æ®              â”‚ â”‚
â”‚  â”‚ - æ¨é€æ›´æ–°   â”‚  â”‚  - å–æ°´è®°å½•              â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  - RLS å®‰å…¨ç­–ç•¥          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Auth (å¯é€‰)  â”‚  â”‚  Storage (å¯é€‰)          â”‚ â”‚
â”‚  â”‚ - åŒ¿åç™»å½•   â”‚  â”‚  - æˆå‘˜å¤´åƒ              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä¸ºä»€ä¹ˆé€‰æ‹© Supabaseï¼Ÿ

| ä¼˜åŠ¿ | è¯´æ˜ | å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ |
|:-----|:-----|:------------|
| **ğŸ’° æˆæœ¬** | å…è´¹é¢åº¦å……è¶³ï¼ˆ500MB + 5GBå¸¦å®½/æœˆï¼‰ | ä¼ ç»Ÿåç«¯ï¼š$20+/æœˆ |
| **âš¡ å®æ—¶åŒæ­¥** | å†…ç½® WebSocketï¼Œè‡ªåŠ¨æ¨é€æ•°æ®å˜æ›´ | éœ€è‡ªè¡Œå®ç° WebSocket æœåŠ¡ |
| **ğŸ”’ å®‰å…¨** | Row Level Security (RLS) è¡Œçº§æƒé™æ§åˆ¶ | éœ€ç¼–å†™åç«¯æƒé™é€»è¾‘ |
| **ğŸš€ å¼€å‘é€Ÿåº¦** | é›¶åç«¯ä»£ç ï¼Œç›´è¿æ•°æ®åº“ | éœ€å¼€å‘å®Œæ•´ REST API |
| **ğŸ“´ ç¦»çº¿æ”¯æŒ** | é…åˆ IndexedDB è½»æ¾å®ç°ç¦»çº¿ä¼˜å…ˆ | éœ€è‡ªè¡Œè®¾è®¡åŒæ­¥æœºåˆ¶ |
| **ğŸ”„ è‡ªåŠ¨æ‰©å±•** | æ— éœ€è¿ç»´ï¼Œè‡ªåŠ¨æ‰©å®¹ | éœ€é…ç½®è´Ÿè½½å‡è¡¡ã€æ•°æ®åº“æ‰©å®¹ |

### æ ¸å¿ƒç‰¹æ€§

1. **PostgreSQL æ•°æ®åº“** - å¼ºå¤§çš„ SQL æŸ¥è¯¢èƒ½åŠ›
2. **Realtime Subscriptions** - è¡¨çº§å®æ—¶è®¢é˜…ï¼Œæ”¯æŒè¿‡æ»¤
3. **RESTful API** - è‡ªåŠ¨ç”Ÿæˆ CRUD API
4. **Row Level Security** - æ•°æ®åº“çº§åˆ«çš„æƒé™æ§åˆ¶
5. **Storage** - æ–‡ä»¶å­˜å‚¨ï¼ˆå¯é€‰ï¼Œç”¨äºæˆå‘˜å¤´åƒï¼‰
6. **Auth** - ç”¨æˆ·è®¤è¯ï¼ˆå¯é€‰ï¼Œæ”¯æŒåŒ¿åç™»å½•ï¼‰

---

## ğŸ“‹ æ•°æ®åº“è®¾è®¡

### Schema è®¾è®¡ (PostgreSQL)

```sql
-- ========== å®¶åº­è¡¨ ==========
CREATE TABLE families (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  invite_code VARCHAR(8) UNIQUE NOT NULL, -- å®¶åº­é‚€è¯·ç 
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ========== å®¶åº­æˆå‘˜è¡¨ ==========
CREATE TABLE family_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  family_id UUID REFERENCES families(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  avatar VARCHAR(10) NOT NULL, -- emoji æˆ–é¢œè‰²ä»£ç 
  daily_goal INTEGER DEFAULT 2000, -- æ¯«å‡
  device_id VARCHAR(100), -- ç”¨äºæ ‡è¯†è®¾å¤‡ï¼ˆå¯é€‰ï¼‰
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•ï¼šå¿«é€ŸæŸ¥è¯¢å®¶åº­æˆå‘˜
CREATE INDEX idx_family_members_family_id ON family_members(family_id);

-- ========== å–æ°´è®°å½•è¡¨ ==========
CREATE TABLE water_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  member_id UUID REFERENCES family_members(id) ON DELETE CASCADE,
  amount INTEGER NOT NULL, -- æ¯«å‡
  recorded_at TIMESTAMP DEFAULT NOW(),
  synced BOOLEAN DEFAULT TRUE -- åŒæ­¥çŠ¶æ€æ ‡è®°
);

-- ç´¢å¼•ï¼šä¼˜åŒ–æ—¥æœŸèŒƒå›´æŸ¥è¯¢
CREATE INDEX idx_water_records_member_recorded 
  ON water_records(member_id, recorded_at DESC);

-- ç´¢å¼•ï¼šä¼˜åŒ–æŒ‰æ—¥æœŸæŸ¥è¯¢
CREATE INDEX idx_water_records_date 
  ON water_records(DATE(recorded_at));

-- ========== æé†’é…ç½®è¡¨ ==========
CREATE TABLE reminder_configs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  member_id UUID REFERENCES family_members(id) ON DELETE CASCADE UNIQUE,
  enabled BOOLEAN DEFAULT TRUE,
  intervals JSONB DEFAULT '[]', -- [8, 10, 12, 14, 16, 18, 20]
  sound_type VARCHAR(20) DEFAULT 'water-drop',
  vibrate BOOLEAN DEFAULT TRUE,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ========== è®¾å¤‡ä»¤ç‰Œè¡¨ï¼ˆç”¨äºæ¨é€é€šçŸ¥ï¼‰==========
CREATE TABLE device_tokens (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  member_id UUID REFERENCES family_members(id) ON DELETE CASCADE,
  token TEXT NOT NULL,
  platform VARCHAR(20), -- 'ios' | 'android' | 'web'
  created_at TIMESTAMP DEFAULT NOW()
);

-- ========== æ•°æ®åº“å‡½æ•°ï¼šç”Ÿæˆå®¶åº­é‚€è¯·ç  ==========
CREATE OR REPLACE FUNCTION generate_invite_code()
RETURNS TEXT AS $$
DECLARE
  chars TEXT := 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; -- å»æ‰æ˜“æ··æ·†å­—ç¬¦ 0O1I
  result TEXT := '';
  i INTEGER;
BEGIN
  FOR i IN 1..6 LOOP
    result := result || substr(chars, floor(random() * length(chars) + 1)::int, 1);
  END LOOP;
  RETURN result;
END;
$$ LANGUAGE plpgsql;

-- ========== æ•°æ®åº“å‡½æ•°ï¼šåˆ›å»ºå®¶åº­å¹¶è¿”å›é‚€è¯·ç  ==========
CREATE OR REPLACE FUNCTION create_family(family_name TEXT, creator_name TEXT, creator_avatar TEXT)
RETURNS JSON AS $$
DECLARE
  new_family_id UUID;
  new_member_id UUID;
  invite_code TEXT;
BEGIN
  -- ç”Ÿæˆå”¯ä¸€é‚€è¯·ç 
  LOOP
    invite_code := generate_invite_code();
    EXIT WHEN NOT EXISTS (SELECT 1 FROM families WHERE families.invite_code = invite_code);
  END LOOP;
  
  -- åˆ›å»ºå®¶åº­
  INSERT INTO families (name, invite_code)
  VALUES (family_name, invite_code)
  RETURNING id INTO new_family_id;
  
  -- æ·»åŠ åˆ›å»ºè€…ä¸ºç¬¬ä¸€ä¸ªæˆå‘˜
  INSERT INTO family_members (family_id, name, avatar, daily_goal)
  VALUES (new_family_id, creator_name, creator_avatar, 2000)
  RETURNING id INTO new_member_id;
  
  -- è¿”å›å®¶åº­ä¿¡æ¯
  RETURN json_build_object(
    'family_id', new_family_id,
    'member_id', new_member_id,
    'invite_code', invite_code
  );
END;
$$ LANGUAGE plpgsql;

-- ========== æ•°æ®åº“å‡½æ•°ï¼šé€šè¿‡é‚€è¯·ç åŠ å…¥å®¶åº­ ==========
CREATE OR REPLACE FUNCTION join_family(
  invite_code_param TEXT,
  member_name TEXT,
  member_avatar TEXT
)
RETURNS JSON AS $$
DECLARE
  target_family_id UUID;
  new_member_id UUID;
BEGIN
  -- æŸ¥æ‰¾å®¶åº­
  SELECT id INTO target_family_id
  FROM families
  WHERE invite_code = invite_code_param;
  
  IF target_family_id IS NULL THEN
    RAISE EXCEPTION 'é‚€è¯·ç æ— æ•ˆ';
  END IF;
  
  -- æ·»åŠ æ–°æˆå‘˜
  INSERT INTO family_members (family_id, name, avatar, daily_goal)
  VALUES (target_family_id, member_name, member_avatar, 2000)
  RETURNING id INTO new_member_id;
  
  -- è¿”å›æˆå‘˜ä¿¡æ¯
  RETURN json_build_object(
    'family_id', target_family_id,
    'member_id', new_member_id
  );
END;
$$ LANGUAGE plpgsql;

-- ========== æ•°æ®åº“å‡½æ•°ï¼šè·å–ä»Šæ—¥å–æ°´ç»Ÿè®¡ ==========
CREATE OR REPLACE FUNCTION get_today_summary(family_id_param UUID)
RETURNS JSON AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_agg(
    json_build_object(
      'member_id', fm.id,
      'member_name', fm.name,
      'avatar', fm.avatar,
      'daily_goal', fm.daily_goal,
      'total_amount', COALESCE(SUM(wr.amount), 0),
      'percentage', ROUND((COALESCE(SUM(wr.amount), 0)::NUMERIC / fm.daily_goal) * 100, 1),
      'record_count', COUNT(wr.id)
    )
  ) INTO result
  FROM family_members fm
  LEFT JOIN water_records wr ON wr.member_id = fm.id 
    AND DATE(wr.recorded_at) = CURRENT_DATE
  WHERE fm.family_id = family_id_param
  GROUP BY fm.id, fm.name, fm.avatar, fm.daily_goal;
  
  RETURN COALESCE(result, '[]'::json);
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ” å®‰å…¨ç­–ç•¥ (Row Level Security)

### è®¾å¤‡è¯†åˆ«æ–¹æ¡ˆ

**ä½¿ç”¨æµè§ˆå™¨æŒ‡çº¹ + LocalStorage ç»„åˆ**ï¼š

```typescript
// core/services/device.service.ts
import { Injectable } from '@angular/core';

@Injectable({ providedIn: 'root' })
export class DeviceService {
  private readonly STORAGE_KEY = 'water_buddy_device_id';
  
  /**
   * è·å–æˆ–ç”Ÿæˆè®¾å¤‡ ID
   */
  getDeviceId(): string {
    let deviceId = localStorage.getItem(this.STORAGE_KEY);
    
    if (!deviceId) {
      // ç”ŸæˆåŸºäºæµè§ˆå™¨æŒ‡çº¹çš„è®¾å¤‡ ID
      deviceId = this.generateDeviceId();
      localStorage.setItem(this.STORAGE_KEY, deviceId);
    }
    
    return deviceId;
  }
  
  private generateDeviceId(): string {
    const fingerprint = [
      navigator.userAgent,
      navigator.language,
      screen.width + 'x' + screen.height,
      new Date().getTimezoneOffset(),
      !!navigator.maxTouchPoints // æ£€æµ‹æ˜¯å¦è§¦æ‘¸è®¾å¤‡
    ].join('|');
    
    // ç”Ÿæˆç®€å•å“ˆå¸Œ
    let hash = 0;
    for (let i = 0; i < fingerprint.length; i++) {
      const char = fingerprint.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    
    return `device_${Math.abs(hash)}_${Date.now()}`;
  }
}
```

### å®Œæ•´ RLS ç­–ç•¥

```sql
-- ========== å¯ç”¨æ‰€æœ‰è¡¨çš„ RLS ==========
ALTER TABLE families ENABLE ROW LEVEL SECURITY;
ALTER TABLE family_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE water_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE reminder_configs ENABLE ROW LEVEL SECURITY;

-- ========== å®¶åº­è¡¨ç­–ç•¥ ==========
-- æ‰€æœ‰äººå¯ä»¥åˆ›å»ºå®¶åº­ï¼ˆé€šè¿‡å‡½æ•°åˆ›å»ºï¼‰
CREATE POLICY "å…è®¸æ‰€æœ‰äººåˆ›å»ºå®¶åº­"
  ON families
  FOR INSERT
  WITH CHECK (true);

-- å®¶åº­æˆå‘˜å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„å®¶åº­ä¿¡æ¯
CREATE POLICY "å®¶åº­æˆå‘˜å¯æŸ¥çœ‹å®¶åº­ä¿¡æ¯"
  ON families
  FOR SELECT
  USING (
    id IN (
      SELECT family_id FROM family_members 
      WHERE id = current_setting('app.current_member_id', true)::UUID
    )
  );

-- å®¶åº­åˆ›å»ºè€…å¯ä»¥æ›´æ–°å®¶åº­åç§°ï¼ˆå¯é€‰æ‰©å±•ï¼‰
CREATE POLICY "å…è®¸æ›´æ–°å®¶åº­ä¿¡æ¯"
  ON families
  FOR UPDATE
  USING (
    id IN (
      SELECT family_id FROM family_members 
      WHERE id = current_setting('app.current_member_id', true)::UUID
    )
  );

-- ========== å®¶åº­æˆå‘˜è¡¨ç­–ç•¥ ==========
-- æ‰€æœ‰äººå¯ä»¥åŠ å…¥å®¶åº­ï¼ˆé€šè¿‡ join_family å‡½æ•°ï¼‰
CREATE POLICY "å…è®¸åŠ å…¥å®¶åº­"
  ON family_members
  FOR INSERT
  WITH CHECK (true);

-- åªèƒ½æŸ¥çœ‹åŒä¸€å®¶åº­çš„æˆå‘˜
CREATE POLICY "æŸ¥çœ‹åŒå®¶åº­æˆå‘˜"
  ON family_members
  FOR SELECT
  USING (
    family_id IN (
      SELECT family_id FROM family_members 
      WHERE id = current_setting('app.current_member_id', true)::UUID
    )
  );

-- åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "æ›´æ–°è‡ªå·±çš„æˆå‘˜ä¿¡æ¯"
  ON family_members
  FOR UPDATE
  USING (id = current_setting('app.current_member_id', true)::UUID);

-- åªèƒ½åˆ é™¤è‡ªå·±ï¼ˆé€€å‡ºå®¶åº­ï¼‰
CREATE POLICY "åˆ é™¤è‡ªå·±çš„æˆå‘˜èµ„æ–™"
  ON family_members
  FOR DELETE
  USING (id = current_setting('app.current_member_id', true)::UUID);

-- ========== å–æ°´è®°å½•è¡¨ç­–ç•¥ ==========
-- åªèƒ½ä¸ºåŒå®¶åº­æˆå‘˜æ·»åŠ è®°å½•
CREATE POLICY "ä¸ºå®¶åº­æˆå‘˜æ·»åŠ å–æ°´è®°å½•"
  ON water_records
  FOR INSERT
  WITH CHECK (
    member_id IN (
      SELECT fm.id FROM family_members fm
      WHERE fm.family_id IN (
        SELECT family_id FROM family_members 
        WHERE id = current_setting('app.current_member_id', true)::UUID
      )
    )
  );

-- åªèƒ½æŸ¥çœ‹åŒå®¶åº­çš„å–æ°´è®°å½•
CREATE POLICY "æŸ¥çœ‹å®¶åº­å–æ°´è®°å½•"
  ON water_records
  FOR SELECT
  USING (
    member_id IN (
      SELECT fm.id FROM family_members fm
      WHERE fm.family_id IN (
        SELECT family_id FROM family_members 
        WHERE id = current_setting('app.current_member_id', true)::UUID
      )
    )
  );

-- åªèƒ½åˆ é™¤åŒå®¶åº­çš„è®°å½•ï¼ˆå¯é€‰ï¼šé™åˆ¶åªèƒ½åˆ é™¤è‡ªå·±çš„ï¼‰
CREATE POLICY "åˆ é™¤å®¶åº­å–æ°´è®°å½•"
  ON water_records
  FOR DELETE
  USING (
    member_id IN (
      SELECT fm.id FROM family_members fm
      WHERE fm.family_id IN (
        SELECT family_id FROM family_members 
        WHERE id = current_setting('app.current_member_id', true)::UUID
      )
    )
  );

-- ========== æé†’é…ç½®è¡¨ç­–ç•¥ ==========
-- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æé†’é…ç½®
CREATE POLICY "æŸ¥çœ‹è‡ªå·±çš„æé†’é…ç½®"
  ON reminder_configs
  FOR SELECT
  USING (member_id = current_setting('app.current_member_id', true)::UUID);

-- åªèƒ½åˆ›å»ºè‡ªå·±çš„æé†’é…ç½®
CREATE POLICY "åˆ›å»ºè‡ªå·±çš„æé†’é…ç½®"
  ON reminder_configs
  FOR INSERT
  WITH CHECK (member_id = current_setting('app.current_member_id', true)::UUID);

-- åªèƒ½æ›´æ–°è‡ªå·±çš„æé†’é…ç½®
CREATE POLICY "æ›´æ–°è‡ªå·±çš„æé†’é…ç½®"
  ON reminder_configs
  FOR UPDATE
  USING (member_id = current_setting('app.current_member_id', true)::UUID);
```

---

## ğŸ’» å‰ç«¯é›†æˆæ–¹æ¡ˆ

### 1. å®‰è£…ä¾èµ–

```bash
npm install @supabase/supabase-js uuid
npm install --save-dev @types/uuid
```

### 2. ç¯å¢ƒé…ç½®

```typescript
// environments/environment.ts
export const environment = {
  production: false,
  supabaseUrl: 'https://your-project.supabase.co',
  supabaseAnonKey: 'your-anon-key-here'
};

// environments/environment.prod.ts
export const environment = {
  production: true,
  supabaseUrl: 'https://your-project.supabase.co',
  supabaseAnonKey: 'your-anon-key-here'
};
```

### 3. Supabase Serviceï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰

```typescript
// core/services/supabase.service.ts
import { Injectable } from '@angular/core';
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import { environment } from '../../../environments/environment';

@Injectable({ providedIn: 'root' })
export class SupabaseService {
  private supabase: SupabaseClient;
  private currentMemberId: string | null = null;
  
  constructor() {
    this.supabase = createClient(
      environment.supabaseUrl,
      environment.supabaseAnonKey
    );
  }
  
  get client(): SupabaseClient {
    return this.supabase;
  }
  
  /**
   * è®¾ç½®å½“å‰æˆå‘˜ IDï¼ˆç”¨äº RLSï¼‰
   * æ¯æ¬¡APIè°ƒç”¨å‰è®¾ç½®ï¼Œç¡®ä¿ RLS ç­–ç•¥ç”Ÿæ•ˆ
   */
  async setCurrentMember(memberId: string): Promise<void> {
    this.currentMemberId = memberId;
    // è®¾ç½® PostgreSQL ä¼šè¯å˜é‡
    await this.supabase.rpc('set_config', {
      setting_name: 'app.current_member_id',
      setting_value: memberId,
      is_local: false
    });
  }
  
  /**
   * æ‰§è¡Œ RPC è°ƒç”¨ï¼ˆæ•°æ®åº“å‡½æ•°ï¼‰
   */
  async callFunction<T = any>(functionName: string, params?: any): Promise<T> {
    const { data, error } = await this.supabase.rpc(functionName, params);
    if (error) throw error;
    return data as T;
  }
}
```

### 4. å®¶åº­ç®¡ç†æœåŠ¡ï¼ˆå®Œæ•´ç‰ˆï¼‰

```typescript
// features/family-progress/services/family.service.ts
import { Injectable } from '@angular/core';
import { SupabaseService } from '../../../core/services/supabase.service';
import { Observable, from, map } from 'rxjs';
import { FamilyMember, Family } from '../models/family-member.interface';

interface CreateFamilyResult {
  family_id: string;
  member_id: string;
  invite_code: string;
}

interface JoinFamilyResult {
  family_id: string;
  member_id: string;
}

@Injectable({ providedIn: 'root' })
export class FamilyService {
  constructor(private supabase: SupabaseService) {}
  
  /**
   * åˆ›å»ºæ–°å®¶åº­
   */
  createFamily(
    familyName: string,
    creatorName: string,
    creatorAvatar: string
  ): Observable<CreateFamilyResult> {
    return from(
      this.supabase.callFunction<CreateFamilyResult>('create_family', {
        family_name: familyName,
        creator_name: creatorName,
        creator_avatar: creatorAvatar
      })
    );
  }
  
  /**
   * é€šè¿‡é‚€è¯·ç åŠ å…¥å®¶åº­
   */
  joinFamily(
    inviteCode: string,
    memberName: string,
    memberAvatar: string
  ): Observable<JoinFamilyResult> {
    return from(
      this.supabase.callFunction<JoinFamilyResult>('join_family', {
        invite_code_param: inviteCode.toUpperCase(),
        member_name: memberName,
        member_avatar: memberAvatar
      })
    );
  }
  
  /**
   * è·å–å®¶åº­ä¿¡æ¯
   */
  getFamily(familyId: string): Observable<Family> {
    return from(
      this.supabase.client
        .from('families')
        .select('*')
        .eq('id', familyId)
        .single()
    ).pipe(
      map(({ data, error }) => {
        if (error) throw error;
        return data as Family;
      })
    );
  }
  
  /**
   * è·å–å®¶åº­æˆå‘˜åˆ—è¡¨
   */
  getMembers(familyId: string): Observable<FamilyMember[]> {
    return from(
      this.supabase.client
        .from('family_members')
        .select('*')
        .eq('family_id', familyId)
        .order('created_at', { ascending: true })
    ).pipe(
      map(({ data, error }) => {
        if (error) throw error;
        return data as FamilyMember[];
      })
    );
  }
  
  /**
   * è·å–ä»Šæ—¥å®¶åº­å–æ°´ç»Ÿè®¡
   */
  getTodaySummary(familyId: string): Observable<any> {
    return from(
      this.supabase.callFunction('get_today_summary', {
        family_id_param: familyId
      })
    );
  }
  
  /**
   * æ›´æ–°å®¶åº­æˆå‘˜ä¿¡æ¯
   */
  updateMember(id: string, updates: Partial<FamilyMember>): Observable<void> {
    return from(
      this.supabase.client
        .from('family_members')
        .update({ ...updates, updated_at: new Date() })
        .eq('id', id)
    ).pipe(
      map(({ error }) => {
        if (error) throw error;
      })
    );
  }
  
  /**
   * é€€å‡ºå®¶åº­ï¼ˆåˆ é™¤æˆå‘˜ï¼‰
   */
  leaveFamily(memberId: string): Observable<void> {
    return from(
      this.supabase.client
        .from('family_members')
        .delete()
        .eq('id', memberId)
    ).pipe(
      map(({ error }) => {
        if (error) throw error;
      })
    );
  }
}
```

### 4. å–æ°´è®°å½•ç®¡ç†æœåŠ¡

```typescript
// features/family-progress/services/water-record.service.ts
import { Injectable } from '@angular/core';
import { SupabaseService } from '../../../core/services/supabase.service';
import { Observable, from, map } from 'rxjs';
import { WaterRecord } from '../models/water-record.interface';

@Injectable({ providedIn: 'root' })
export class WaterRecordService {
  constructor(private supabase: SupabaseService) {}
  
  /**
   * æ·»åŠ å–æ°´è®°å½•
   */
  addRecord(record: Partial<WaterRecord>): Observable<WaterRecord> {
    return from(
      this.supabase.client
        .from('water_records')
        .insert(record)
        .select()
        .single()
    ).pipe(
      map(({ data, error }) => {
        if (error) throw error;
        return data as WaterRecord;
      })
    );
  }
  
  /**
   * è·å–æŒ‡å®šæ—¥æœŸçš„è®°å½•
   */
  getRecordsByDate(memberId: string, date: string): Observable<WaterRecord[]> {
    return from(
      this.supabase.client
        .from('water_records')
        .select('*')
        .eq('member_id', memberId)
        .gte('recorded_at', `${date}T00:00:00`)
        .lte('recorded_at', `${date}T23:59:59`)
        .order('recorded_at', { ascending: false })
    ).pipe(
      map(({ data, error }) => {
        if (error) throw error;
        return data as WaterRecord[];
      })
    );
  }
  
  /**
   * åˆ é™¤è®°å½•
   */
  deleteRecord(id: string): Observable<void> {
    return from(
      this.supabase.client
        .from('water_records')
        .delete()
        .eq('id', id)
    ).pipe(
      map(({ error }) => {
        if (error) throw error;
      })
    );
  }
}
```

---

## ğŸ”„ å®æ—¶åŒæ­¥å®ç°

### Realtime Service

```typescript
// core/services/realtime.service.ts
import { Injectable, OnDestroy } from '@angular/core';
import { SupabaseService } from './supabase.service';
import { Subject, Observable } from 'rxjs';
import { RealtimeChannel } from '@supabase/supabase-js';

export interface RealtimeEvent<T = any> {
  type: 'INSERT' | 'UPDATE' | 'DELETE';
  table: string;
  new: T;
  old: T;
}

@Injectable({ providedIn: 'root' })
export class RealtimeService implements OnDestroy {
  private channels: Map<string, RealtimeChannel> = new Map();
  private events$ = new Subject<RealtimeEvent>();
  
  constructor(private supabase: SupabaseService) {}
  
  /**
   * è®¢é˜…è¡¨å˜æ›´
   */
  subscribe(table: string, filter?: string): Observable<RealtimeEvent> {
    if (!this.channels.has(table)) {
      const channel = this.supabase.client
        .channel(`public:${table}`)
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table, filter },
          (payload) => {
            this.events$.next({
              type: payload.eventType as any,
              table,
              new: payload.new,
              old: payload.old
            });
          }
        )
        .subscribe();
      
      this.channels.set(table, channel);
    }
    
    return this.events$.asObservable();
  }
  
  /**
   * å–æ¶ˆè®¢é˜…
   */
  unsubscribe(table: string): void {
    const channel = this.channels.get(table);
    if (channel) {
      this.supabase.client.removeChannel(channel);
      this.channels.delete(table);
    }
  }
  
  ngOnDestroy(): void {
    this.channels.forEach((channel) => {
      this.supabase.client.removeChannel(channel);
    });
    this.channels.clear();
  }
}
```

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å®æ—¶åŒæ­¥

```typescript
// features/family-progress/containers/family-dashboard.component.ts
import { Component, OnInit, OnDestroy } from '@angular/core';
import { RealtimeService } from '../../../core/services/realtime.service';
import { WaterRecordService } from '../services/water-record.service';
import { Subject, takeUntil } from 'rxjs';

@Component({
  selector: 'app-family-dashboard',
  templateUrl: './family-dashboard.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class FamilyDashboardComponent implements OnInit, OnDestroy {
  private destroy$ = new Subject<void>();
  
  constructor(
    private realtime: RealtimeService,
    private waterRecordService: WaterRecordService,
    private cdr: ChangeDetectorRef
  ) {}
  
  ngOnInit(): void {
    // è®¢é˜…å–æ°´è®°å½•å®æ—¶æ›´æ–°
    this.realtime
      .subscribe('water_records')
      .pipe(takeUntil(this.destroy$))
      .subscribe((event) => {
        if (event.type === 'INSERT') {
          console.log('æ–°å¢å–æ°´è®°å½•:', event.new);
          this.refreshData();
        } else if (event.type === 'UPDATE') {
          console.log('æ›´æ–°å–æ°´è®°å½•:', event.new);
          this.refreshData();
        } else if (event.type === 'DELETE') {
          console.log('åˆ é™¤å–æ°´è®°å½•:', event.old);
          this.refreshData();
        }
        this.cdr.markForCheck();
      });
  }
  
  refreshData(): void {
    // åˆ·æ–°æ•°æ®é€»è¾‘
  }
  
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
    this.realtime.unsubscribe('water_records');
  }
}
```

---

## ğŸ“´ ç¦»çº¿ä¼˜å…ˆç­–ç•¥ (Offline-First)

### æ··åˆå­˜å‚¨ç­–ç•¥

```typescript
// core/services/storage.service.ts (æ”¹è¿›ç‰ˆ)
import { Injectable } from '@angular/core';
import { SupabaseService } from './supabase.service';
import { Observable, from, of, throwError } from 'rxjs';
import { catchError, switchMap, tap } from 'rxjs/operators';

@Injectable({ providedIn: 'root' })
export class StorageService {
  private db: IDBDatabase | null = null;
  
  constructor(private supabase: SupabaseService) {
    this.initIndexedDB();
  }
  
  /**
   * æ·»åŠ è®°å½•ï¼ˆç¦»çº¿ä¼˜å…ˆï¼‰
   */
  addRecord(record: WaterRecord): Observable<WaterRecord> {
    // 1. å…ˆå­˜æœ¬åœ° IndexedDB
    return from(this.saveToIndexedDB(record)).pipe(
      // 2. å†åŒæ­¥åˆ° Supabaseï¼ˆå¦‚æœåœ¨çº¿ï¼‰
      switchMap(() => {
        if (navigator.onLine) {
          return from(
            this.supabase.client
              .from('water_records')
              .insert({ ...record, synced: true })
              .select()
              .single()
          ).pipe(
            catchError((error) => {
              // åŒæ­¥å¤±è´¥ï¼Œæ ‡è®°ä¸ºæœªåŒæ­¥
              this.markAsUnsynced(record.id);
              return throwError(() => error);
            })
          );
        } else {
          // ç¦»çº¿çŠ¶æ€ï¼Œæ ‡è®°ä¸ºæœªåŒæ­¥
          return of({ ...record, synced: false });
        }
      })
    );
  }
  
  /**
   * åå°åŒæ­¥æœªåŒæ­¥æ•°æ®
   */
  syncPendingRecords(): Observable<void> {
    return from(this.getUnsyncedRecords()).pipe(
      switchMap((records) => {
        const syncTasks = records.map((record) =>
          this.supabase.client
            .from('water_records')
            .upsert({ ...record, synced: true })
        );
        return from(Promise.all(syncTasks));
      }),
      tap(() => console.log('åŒæ­¥å®Œæˆ'))
    );
  }
  
  private async initIndexedDB(): Promise<void> {
    // IndexedDB åˆå§‹åŒ–é€»è¾‘
  }
  
  private async saveToIndexedDB(record: WaterRecord): Promise<void> {
    // ä¿å­˜åˆ° IndexedDB
  }
  
  private async markAsUnsynced(id: string): Promise<void> {
    // æ ‡è®°ä¸ºæœªåŒæ­¥
  }
  
  private async getUnsyncedRecords(): Promise<WaterRecord[]> {
    // è·å–æœªåŒæ­¥è®°å½•
    return [];
  }
}
```

---

## ğŸ’° æˆæœ¬åˆ†æ

### Supabase å…è´¹é¢åº¦ï¼ˆè¶³å¤Ÿå®¶åº­ä½¿ç”¨ï¼‰

| èµ„æº | å…è´¹é¢åº¦ | é¢„ä¼°ä½¿ç”¨ | æ˜¯å¦è¶³å¤Ÿ |
|:-----|:---------|:---------|:---------|
| æ•°æ®åº“å­˜å‚¨ | 500 MB | < 10 MB (1ä¸‡æ¡è®°å½•) | âœ… è¶³å¤Ÿ |
| å¸¦å®½ | 5 GB/æœˆ | < 100 MB/æœˆ | âœ… è¶³å¤Ÿ |
| å®æ—¶è¿æ¥ | 200 å¹¶å‘ | < 10 å¹¶å‘ | âœ… è¶³å¤Ÿ |
| API è¯·æ±‚ | æ— é™ | çº¦ 1000/å¤© | âœ… è¶³å¤Ÿ |

**æ€»æˆæœ¬ï¼š$0/æœˆ** ğŸ‰

---

---

## ğŸ¬ åº”ç”¨åˆå§‹åŒ–æµç¨‹

### é¦–æ¬¡æ‰“å¼€åº”ç”¨

```typescript
// app.component.ts
import { Component, OnInit } from '@angular/core';
import { DeviceService } from './core/services/device.service';
import { SupabaseService } from './core/services/supabase.service';
import { Router } from '@angular/router';

@Component({
  selector: 'app-root',
  template: '<router-outlet></router-outlet>'
})
export class AppComponent implements OnInit {
  constructor(
    private deviceService: DeviceService,
    private supabase: SupabaseService,
    private router: Router
  ) {}
  
  async ngOnInit(): Promise<void> {
    // 1. è·å–è®¾å¤‡ ID
    const deviceId = this.deviceService.getDeviceId();
    
    // 2. æ£€æŸ¥æ˜¯å¦å·²åŠ å…¥å®¶åº­
    const localData = localStorage.getItem('water_buddy_user');
    
    if (localData) {
      const { familyId, memberId } = JSON.parse(localData);
      // è®¾ç½®å½“å‰æˆå‘˜ï¼ˆç”¨äº RLSï¼‰
      await this.supabase.setCurrentMember(memberId);
      // è·³è½¬åˆ°ä»ªè¡¨ç›˜
      this.router.navigate(['/dashboard']);
    } else {
      // é¦–æ¬¡ä½¿ç”¨ï¼Œè·³è½¬åˆ°æ¬¢è¿é¡µ
      this.router.navigate(['/welcome']);
    }
  }
}
```

### æ¬¢è¿é¡µæµç¨‹

```typescript
// features/welcome/welcome.component.ts
@Component({
  selector: 'app-welcome',
  template: `
    <div class="welcome-container">
      <h1>æ¬¢è¿ä½¿ç”¨ Water Buddy</h1>
      <p>å¼€å§‹æ‚¨çš„å¥åº·å–æ°´ä¹‹æ—…</p>
      
      <button (click)="createNewFamily()">åˆ›å»ºå®¶åº­</button>
      <button (click)="joinExistingFamily()">åŠ å…¥å®¶åº­</button>
    </div>
  `
})
export class WelcomeComponent {
  constructor(
    private familyService: FamilyService,
    private router: Router
  ) {}
  
  createNewFamily(): void {
    // æ‰“å¼€åˆ›å»ºå®¶åº­å¯¹è¯æ¡†
    this.showCreateFamilyDialog();
  }
  
  joinExistingFamily(): void {
    // æ‰“å¼€è¾“å…¥é‚€è¯·ç å¯¹è¯æ¡†
    this.showJoinFamilyDialog();
  }
  
  private showCreateFamilyDialog(): void {
    // å¼¹çª—è¾“å…¥ï¼šå®¶åº­åç§°ã€æ‚¨çš„åå­—ã€é€‰æ‹©å¤´åƒ
    const familyName = prompt('å®¶åº­åç§°');
    const memberName = prompt('æ‚¨çš„åå­—');
    const avatar = 'ğŸ‘¤'; // å¯ä»¥æ˜¯ emoji é€‰æ‹©å™¨
    
    this.familyService.createFamily(familyName, memberName, avatar)
      .subscribe({
        next: (result) => {
          // ä¿å­˜åˆ°æœ¬åœ°
          localStorage.setItem('water_buddy_user', JSON.stringify({
            familyId: result.family_id,
            memberId: result.member_id,
            inviteCode: result.invite_code
          }));
          
          // æ˜¾ç¤ºé‚€è¯·ç 
          alert(`å®¶åº­åˆ›å»ºæˆåŠŸï¼é‚€è¯·ç ï¼š${result.invite_code}`);
          
          // è·³è½¬åˆ°ä»ªè¡¨ç›˜
          this.router.navigate(['/dashboard']);
        },
        error: (err) => console.error('åˆ›å»ºå¤±è´¥:', err)
      });
  }
  
  private showJoinFamilyDialog(): void {
    const inviteCode = prompt('è¯·è¾“å…¥é‚€è¯·ç ');
    const memberName = prompt('æ‚¨çš„åå­—');
    const avatar = 'ğŸ‘¤';
    
    this.familyService.joinFamily(inviteCode, memberName, avatar)
      .subscribe({
        next: (result) => {
          localStorage.setItem('water_buddy_user', JSON.stringify({
            familyId: result.family_id,
            memberId: result.member_id
          }));
          
          alert('åŠ å…¥æˆåŠŸï¼');
          this.router.navigate(['/dashboard']);
        },
        error: (err) => alert('åŠ å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚€è¯·ç ')
      });
  }
}
```

---

## ğŸ“´ ç¦»çº¿ä¼˜å…ˆå®Œæ•´å®ç°

### IndexedDB å°è£…æœåŠ¡

```typescript
// core/services/indexed-db.service.ts
import { Injectable } from '@angular/core';
import { from, Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class IndexedDBService {
  private db: IDBDatabase | null = null;
  private readonly DB_NAME = 'water_buddy_db';
  private readonly DB_VERSION = 1;
  
  constructor() {
    this.initDB();
  }
  
  private async initDB(): Promise<void> {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };
      
      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;
        
        // åˆ›å»ºå–æ°´è®°å½•è¡¨
        if (!db.objectStoreNames.contains('water_records')) {
          const recordStore = db.createObjectStore('water_records', { keyPath: 'id' });
          recordStore.createIndex('member_id', 'member_id', { unique: false });
          recordStore.createIndex('synced', 'synced', { unique: false });
          recordStore.createIndex('recorded_at', 'recorded_at', { unique: false });
        }
        
        // åˆ›å»ºå®¶åº­æˆå‘˜ç¼“å­˜è¡¨
        if (!db.objectStoreNames.contains('family_members_cache')) {
          db.createObjectStore('family_members_cache', { keyPath: 'id' });
        }
      };
    });
  }
  
  /**
   * ä¿å­˜è®°å½•åˆ° IndexedDB
   */
  saveRecord(record: any): Observable<void> {
    return from(new Promise<void>((resolve, reject) => {
      if (!this.db) return reject('DB not initialized');
      
      const transaction = this.db.transaction(['water_records'], 'readwrite');
      const store = transaction.objectStore('water_records');
      const request = store.put(record);
      
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    }));
  }
  
  /**
   * è·å–æœªåŒæ­¥çš„è®°å½•
   */
  getUnsyncedRecords(): Observable<any[]> {
    return from(new Promise<any[]>((resolve, reject) => {
      if (!this.db) return reject('DB not initialized');
      
      const transaction = this.db.transaction(['water_records'], 'readonly');
      const store = transaction.objectStore('water_records');
      const index = store.index('synced');
      const request = index.getAll(false);
      
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    }));
  }
  
  /**
   * æ ‡è®°è®°å½•ä¸ºå·²åŒæ­¥
   */
  markAsSynced(recordId: string): Observable<void> {
    return from(new Promise<void>((resolve, reject) => {
      if (!this.db) return reject('DB not initialized');
      
      const transaction = this.db.transaction(['water_records'], 'readwrite');
      const store = transaction.objectStore('water_records');
      const getRequest = store.get(recordId);
      
      getRequest.onsuccess = () => {
        const record = getRequest.result;
        if (record) {
          record.synced = true;
          const updateRequest = store.put(record);
          updateRequest.onsuccess = () => resolve();
          updateRequest.onerror = () => reject(updateRequest.error);
        } else {
          resolve();
        }
      };
      
      getRequest.onerror = () => reject(getRequest.error);
    }));
  }
}
```

### åŒæ­¥æœåŠ¡

```typescript
// core/services/sync.service.ts
import { Injectable } from '@angular/core';
import { IndexedDBService } from './indexed-db.service';
import { SupabaseService } from './supabase.service';
import { interval, fromEvent, merge } from 'rxjs';
import { switchMap, filter } from 'rxjs/operators';

@Injectable({ providedIn: 'root' })
export class SyncService {
  constructor(
    private indexedDB: IndexedDBService,
    private supabase: SupabaseService
  ) {
    this.setupAutoSync();
  }
  
  /**
   * è®¾ç½®è‡ªåŠ¨åŒæ­¥
   */
  private setupAutoSync(): void {
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    const online$ = fromEvent(window, 'online');
    
    // å®šæœŸåŒæ­¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    const periodic$ = interval(5 * 60 * 1000);
    
    // åˆå¹¶è§¦å‘å™¨
    merge(online$, periodic$)
      .pipe(
        filter(() => navigator.onLine),
        switchMap(() => this.syncPendingRecords())
      )
      .subscribe({
        next: () => console.log('âœ… åŒæ­¥å®Œæˆ'),
        error: (err) => console.error('âŒ åŒæ­¥å¤±è´¥:', err)
      });
  }
  
  /**
   * åŒæ­¥å¾…åŒæ­¥çš„è®°å½•
   */
  async syncPendingRecords(): Promise<void> {
    const unsyncedRecords = await this.indexedDB.getUnsyncedRecords().toPromise();
    
    if (!unsyncedRecords || unsyncedRecords.length === 0) {
      return;
    }
    
    console.log(`å¼€å§‹åŒæ­¥ ${unsyncedRecords.length} æ¡è®°å½•...`);
    
    for (const record of unsyncedRecords) {
      try {
        await this.supabase.client
          .from('water_records')
          .upsert(record);
        
        await this.indexedDB.markAsSynced(record.id).toPromise();
        console.log(`âœ… å·²åŒæ­¥è®°å½• ${record.id}`);
      } catch (error) {
        console.error(`âŒ åŒæ­¥å¤±è´¥ ${record.id}:`, error);
      }
    }
  }
}
```

---

## ğŸ› ï¸ éƒ¨ç½²æ–¹æ¡ˆ

### å‰ç«¯éƒ¨ç½²ï¼šCloudflare Pagesï¼ˆæ¨èï¼‰

```bash
# 1. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
ng build --configuration production

# 2. éƒ¨ç½²ï¼ˆä¸¤ç§æ–¹å¼ï¼‰

# æ–¹å¼ä¸€ï¼šè‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰
# - è¿æ¥ GitHub ä»“åº“
# - æ¯æ¬¡ push è‡ªåŠ¨æ„å»ºéƒ¨ç½²
# - è®¿é—® https://pages.cloudflare.com/

# æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²
npx wrangler pages publish dist/ng-water-buddy
```

**Cloudflare Pages é…ç½®**ï¼š
- Build command: `ng build --prod`
- Build output directory: `dist/ng-water-buddy`
- Environment variables: `SUPABASE_URL`, `SUPABASE_ANON_KEY`

### å¤‡é€‰éƒ¨ç½²å¹³å°

| å¹³å° | å…è´¹é¢åº¦ | CDN | è‡ªåŠ¨éƒ¨ç½² | æ¨èåº¦ |
|:-----|:---------|:----|:---------|:-------|
| **Cloudflare Pages** | æ— é™ | âœ… å…¨çƒ | âœ… | â­â­â­â­â­ |
| **Vercel** | 100GB/æœˆ | âœ… å…¨çƒ | âœ… | â­â­â­â­â­ |
| **Netlify** | 100GB/æœˆ | âœ… å…¨çƒ | âœ… | â­â­â­â­ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼ˆ5æ­¥ä¸Šçº¿ï¼‰

### ç¬¬1æ­¥ï¼šåˆ›å»º Supabase é¡¹ç›®ï¼ˆ10åˆ†é’Ÿï¼‰

1. è®¿é—® [supabase.com](https://supabase.com) æ³¨å†Œè´¦å·
2. ç‚¹å‡» "New Project"ï¼Œå¡«å†™é¡¹ç›®åç§°
3. ç­‰å¾…é¡¹ç›®åˆå§‹åŒ–å®Œæˆ
4. è¿›å…¥ SQL Editorï¼Œå¤åˆ¶å¹¶æ‰§è¡Œæœ¬æ–‡æ¡£ä¸­çš„ SQL ä»£ç ï¼ˆåŒ…æ‹¬è¡¨åˆ›å»º + å‡½æ•° + RLS ç­–ç•¥ï¼‰
5. åœ¨ Settings â†’ API ä¸­è·å–ï¼š
   - `Project URL` (å¤åˆ¶ä¸º `SUPABASE_URL`)
   - `anon public` key (å¤åˆ¶ä¸º `SUPABASE_ANON_KEY`)

### ç¬¬2æ­¥ï¼šå…‹éš†é¡¹ç›®å¹¶é…ç½®ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/yourusername/ng-water-buddy.git
cd ng-water-buddy

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
# ç¼–è¾‘ src/environments/environment.ts å’Œ environment.prod.ts
# å¡«å…¥ä¸Šä¸€æ­¥è·å–çš„ SUPABASE_URL å’Œ SUPABASE_ANON_KEY
```

### ç¬¬3æ­¥ï¼šæœ¬åœ°å¼€å‘æµ‹è¯•ï¼ˆ30åˆ†é’Ÿï¼‰

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
ng serve

# æµè§ˆå™¨è®¿é—® http://localhost:4200
# æµ‹è¯•åŠŸèƒ½ï¼š
# - åˆ›å»ºå®¶åº­ï¼ˆè·å¾—é‚€è¯·ç ï¼‰
# - ç”¨å¦ä¸€ä¸ªæµè§ˆå™¨çª—å£åŠ å…¥å®¶åº­
# - æ·»åŠ å–æ°´è®°å½•ï¼ŒéªŒè¯å®æ—¶åŒæ­¥
```

### ç¬¬4æ­¥ï¼šéƒ¨ç½²åˆ° Cloudflare Pagesï¼ˆ15åˆ†é’Ÿï¼‰

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
ng build --prod

# æ¨é€åˆ° GitHub
git add .
git commit -m "Initial commit"
git push origin main

# åœ¨ Cloudflare Pages è¿æ¥ GitHub ä»“åº“
# 1. è®¿é—® https://pages.cloudflare.com/
# 2. ç‚¹å‡» "Create a project"
# 3. é€‰æ‹© GitHub ä»“åº“
# 4. é…ç½®æ„å»ºè®¾ç½®ï¼š
#    - Build command: ng build --prod
#    - Output: dist/ng-water-buddy
# 5. æ·»åŠ ç¯å¢ƒå˜é‡
# 6. ç‚¹å‡» "Save and Deploy"
```

### ç¬¬5æ­¥ï¼šiPhone å®‰è£… PWAï¼ˆ5åˆ†é’Ÿï¼‰

1. ç”¨ Safari æµè§ˆå™¨è®¿é—®éƒ¨ç½²åçš„ç½‘å€
2. ç‚¹å‡»åº•éƒ¨åˆ†äº«æŒ‰é’®
3. é€‰æ‹©"æ·»åŠ åˆ°ä¸»å±å¹•"
4. ç¡®è®¤ï¼ŒPWA å®‰è£…å®Œæˆï¼
5. ä»ä¸»å±å¹•æ‰“å¼€ Water Buddyï¼Œäº«å—åŸç”Ÿ App ä½“éªŒ

---

## ğŸ“‹ å®Œæ•´å®æ–½æ£€æŸ¥æ¸…å•

### âœ… Supabase åç«¯è®¾ç½®ï¼ˆ30åˆ†é’Ÿï¼‰
- [ ] æ³¨å†Œ Supabase è´¦å·å¹¶åˆ›å»ºé¡¹ç›®
- [ ] æ‰§è¡Œæ•°æ®åº“ Schemaï¼ˆè¡¨ + ç´¢å¼•ï¼‰
- [ ] æ‰§è¡Œæ•°æ®åº“å‡½æ•°ï¼ˆåˆ›å»ºå®¶åº­ã€åŠ å…¥å®¶åº­ã€ç»Ÿè®¡ï¼‰
- [ ] é…ç½® RLS å®‰å…¨ç­–ç•¥
- [ ] æµ‹è¯• SQL å‡½æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] è·å– API URL å’Œ Key

### âœ… å‰ç«¯å¼€å‘ï¼ˆ4-5å¤©ï¼‰
- [ ] å®‰è£…ä¾èµ–ï¼š`@supabase/supabase-js`, `uuid`
- [ ] åˆ›å»º DeviceServiceï¼ˆè®¾å¤‡è¯†åˆ«ï¼‰
- [ ] åˆ›å»º SupabaseServiceï¼ˆæ•°æ®åº“è¿æ¥ï¼‰
- [ ] åˆ›å»º FamilyServiceï¼ˆå®¶åº­ç®¡ç†ï¼‰
- [ ] åˆ›å»º WaterRecordServiceï¼ˆå–æ°´è®°å½•ï¼‰
- [ ] åˆ›å»º RealtimeServiceï¼ˆå®æ—¶åŒæ­¥ï¼‰
- [ ] åˆ›å»º IndexedDBServiceï¼ˆç¦»çº¿å­˜å‚¨ï¼‰
- [ ] åˆ›å»º SyncServiceï¼ˆåå°åŒæ­¥ï¼‰
- [ ] å®ç°æ¬¢è¿é¡µï¼ˆåˆ›å»º/åŠ å…¥å®¶åº­ï¼‰
- [ ] å®ç°ä»ªè¡¨ç›˜ï¼ˆè¿›åº¦å±•ç¤ºï¼‰
- [ ] å®ç°æé†’åŠŸèƒ½
- [ ] å®ç°è®¾ç½®é¡µé¢

### âœ… æµ‹è¯•ï¼ˆ2å¤©ï¼‰
- [ ] å•è®¾å¤‡åŠŸèƒ½æµ‹è¯•
- [ ] å¤šè®¾å¤‡å®æ—¶åŒæ­¥æµ‹è¯•
- [ ] ç¦»çº¿æ¨¡å¼æµ‹è¯•ï¼ˆé£è¡Œæ¨¡å¼ï¼‰
- [ ] ç½‘ç»œæ¢å¤è‡ªåŠ¨åŒæ­¥æµ‹è¯•
- [ ] iPhone Safari å…¼å®¹æ€§æµ‹è¯•
- [ ] PWA å®‰è£…æµç¨‹æµ‹è¯•
- [ ] é€šçŸ¥æƒé™æµ‹è¯•

### âœ… éƒ¨ç½²ä¸Šçº¿ï¼ˆ1å¤©ï¼‰
- [ ] é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
- [ ] æ„å»ºç”Ÿäº§ç‰ˆæœ¬å¹¶æµ‹è¯•
- [ ] éƒ¨ç½²åˆ° Cloudflare Pages
- [ ] é…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰
- [ ] é…ç½® HTTPSï¼ˆè‡ªåŠ¨ï¼‰
- [ ] PWA Lighthouse å®¡è®¡ï¼ˆç›®æ ‡ >90 åˆ†ï¼‰
- [ ] çœŸæœºæµ‹è¯•ï¼ˆiPhone 15/16ï¼‰

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. ç¯å¢ƒå˜é‡é…ç½®

```typescript
// environments/environment.prod.ts
export const environment = {
  production: true,
  supabaseUrl: 'https://your-project.supabase.co',
  supabaseAnonKey: 'your-anon-key', // è¿™æ˜¯å…¬å¼€çš„ï¼Œå®‰å…¨çš„
};
```

### 2. RLS ç­–ç•¥å¼ºåˆ¶æ‰§è¡Œ

```sql
-- ç¡®ä¿æ‰€æœ‰è¡¨éƒ½å¯ç”¨ RLS
ALTER TABLE families FORCE ROW LEVEL SECURITY;
ALTER TABLE family_members FORCE ROW LEVEL SECURITY;
ALTER TABLE water_records FORCE ROW LEVEL SECURITY;
```

### 3. è¾“å…¥éªŒè¯

```typescript
// åœ¨æœåŠ¡å±‚éªŒè¯è¾“å…¥
addRecord(record: WaterRecord): Observable<WaterRecord> {
  if (record.amount <= 0 || record.amount > 5000) {
    return throwError(() => new Error('æ— æ•ˆçš„æ°´é‡'));
  }
  // ...
}
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Supabase å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [Supabase Realtime æ–‡æ¡£](https://supabase.com/docs/guides/realtime)
- [PostgreSQL RLS æ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
- [Cloudflare Pages æ–‡æ¡£](https://developers.cloudflare.com/pages/)

---

## ğŸ¯ æ–¹æ¡ˆæ€»ç»“

### æœ€ç»ˆæŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯æ–¹æ¡ˆ | æˆæœ¬ |
|:-----|:---------|:-----|
| **æ•°æ®åº“** | Supabase PostgreSQL | $0/æœˆï¼ˆå…è´¹é¢åº¦ï¼‰ |
| **å®æ—¶åŒæ­¥** | Supabase Realtime (WebSocket) | $0/æœˆï¼ˆåŒ…å«åœ¨å…è´¹é¢åº¦ï¼‰ |
| **å‰ç«¯æ¡†æ¶** | Angular 17 + PWA | æ—  |
| **ç¦»çº¿å­˜å‚¨** | IndexedDB | æ—  |
| **éƒ¨ç½²å¹³å°** | Cloudflare Pages | $0/æœˆï¼ˆå…è´¹ï¼‰ |
| **CDN** | Cloudflare å…¨çƒ CDN | $0/æœˆï¼ˆåŒ…å«ï¼‰ |

**æ€»æˆæœ¬ï¼š$0/æœˆ** ğŸ‰

### æ¶æ„ä¼˜åŠ¿

âœ… **é›¶æˆæœ¬** - å®Œå…¨å…è´¹ï¼Œé€‚åˆä¸ªäººå’Œå®¶åº­ä½¿ç”¨  
âœ… **é›¶è¿ç»´** - æ— éœ€ç®¡ç†æœåŠ¡å™¨ï¼ŒSupabase è‡ªåŠ¨æ‰©å±•å’Œå¤‡ä»½  
âœ… **å®æ—¶åŒæ­¥** - å¤šè®¾å¤‡è‡ªåŠ¨åŒæ­¥ï¼Œæ— éœ€è½®è¯¢  
âœ… **ç¦»çº¿ä¼˜å…ˆ** - IndexedDB + åå°åŒæ­¥ï¼Œç½‘ç»œæ¢å¤è‡ªåŠ¨æ¨é€  
âœ… **å®‰å…¨å¯é ** - RLS è¡Œçº§æƒé™æ§åˆ¶ï¼Œæ•°æ®éš”ç¦»  
âœ… **å¿«é€Ÿå¼€å‘** - å‰ç«¯ç›´è¿æ•°æ®åº“ï¼Œæ— éœ€ç¼–å†™åç«¯ API  
âœ… **å…¨çƒåŠ é€Ÿ** - Cloudflare CDNï¼Œè®¿é—®é€Ÿåº¦å¿«  
âœ… **PWA æ”¯æŒ** - iPhone å¯å®‰è£…ï¼ŒåŸç”Ÿ App ä½“éªŒ

### ä¸ºä»€ä¹ˆä¸éœ€è¦ä¼ ç»Ÿåç«¯ï¼Ÿ

| ä¼ ç»Ÿæ–¹æ¡ˆ | Supabase æ–¹æ¡ˆ |
|:---------|:-------------|
| éœ€è¦ç¼–å†™ REST API | âœ… è‡ªåŠ¨ç”Ÿæˆ RESTful API |
| éœ€è¦å®ç° WebSocket æœåŠ¡ | âœ… å†…ç½® Realtime |
| éœ€è¦ç¼–å†™æƒé™éªŒè¯é€»è¾‘ | âœ… RLS æ•°æ®åº“çº§æƒé™ |
| éœ€è¦éƒ¨ç½²æœåŠ¡å™¨ï¼ˆDocker/K8sï¼‰ | âœ… æ— éœ€éƒ¨ç½²ï¼Œç›´è¿ |
| éœ€è¦é…ç½®è´Ÿè½½å‡è¡¡ | âœ… è‡ªåŠ¨æ‰©å±• |
| éœ€è¦é…ç½®æ•°æ®åº“å¤‡ä»½ | âœ… è‡ªåŠ¨æ¯æ—¥å¤‡ä»½ |
| æˆæœ¬ï¼š$20+/æœˆ | âœ… æˆæœ¬ï¼š$0/æœˆ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### Supabase å…è´¹ç‰ˆé™åˆ¶

| é™åˆ¶é¡¹ | å…è´¹é¢åº¦ | åº”å¯¹æ–¹æ¡ˆ |
|:------|:---------|:--------|
| æ•°æ®åº“å¤§å° | 500 MB | å®šæœŸæ¸…ç†å†å²è®°å½•ï¼ˆä¿ç•™3ä¸ªæœˆï¼‰ |
| å¸¦å®½ | 5 GB/æœˆ | PWA ç¦»çº¿ç¼“å­˜å‡å°‘è¯·æ±‚ |
| å®æ—¶è¿æ¥æ•° | 200 å¹¶å‘ | å®¶åº­åº”ç”¨è¶³å¤Ÿ |

### iPhone PWA é™åˆ¶

- iOS 16.4+ æ‰æ”¯æŒ PWA é€šçŸ¥
- å¿…é¡»"æ·»åŠ åˆ°ä¸»å±å¹•"åé€šçŸ¥æ‰ç”Ÿæ•ˆ
- éœ€å¼•å¯¼ç”¨æˆ·å®Œæˆå®‰è£…æµç¨‹

### æ•°æ®å¤‡ä»½å»ºè®®

è™½ç„¶ Supabase ä¼šè‡ªåŠ¨å¤‡ä»½ï¼Œä½†å»ºè®®ï¼š
- å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆJSON æ ¼å¼ï¼‰
- å®šæœŸä¸‹è½½å¤‡ä»½åˆ°æœ¬åœ°
- é‡è¦æ•°æ®å¯åŒå­˜å‚¨ï¼ˆSupabase + LocalStorageï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

- [Supabase å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [Supabase Realtime æ–‡æ¡£](https://supabase.com/docs/guides/realtime)
- [PostgreSQL RLS æ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
- [Cloudflare Pages æ–‡æ¡£](https://developers.cloudflare.com/pages/)
- [Angular PWA æ–‡æ¡£](https://angular.io/guide/service-worker-intro)
- [iOS PWA æ”¯æŒ](https://webkit.org/blog/13878/web-push-for-web-apps-on-ios-and-ipados/)

---

## ğŸ’¬ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æœ¬æ–‡æ¡£çš„"å¿«é€Ÿå¼€å§‹æŒ‡å—"éƒ¨åˆ†
2. Supabase å®˜æ–¹æ–‡æ¡£
3. GitHub Issuesï¼ˆå¦‚æœé¡¹ç›®å¼€æºï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-03  
**ç»´æŠ¤è€…**: kreiven

**å˜æ›´è®°å½•**ï¼š
- v2.0 (2025-10-03): å®Œæ•´é‡æ„ï¼Œèšç„¦ Supabase æ–¹æ¡ˆï¼Œæ·»åŠ å®Œæ•´ä»£ç ç¤ºä¾‹å’Œå¿«é€Ÿå¼€å§‹æŒ‡å—
- v1.0 (2025-10-03): åˆå§‹ç‰ˆæœ¬

